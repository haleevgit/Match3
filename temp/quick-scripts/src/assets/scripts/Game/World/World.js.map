{"version":3,"sources":["assets/scripts/Game/World/World.js"],"names":["cc","Class","Component","properties","data","type","JsonAsset","tooltip","isLoad","serializable","visible","notify","systemEvent","emit","GameEvent","WORLD_LOADED","_isInitiated","_data","_render","RenderList","_objectArray","onLoad","getComponent","addComponent","_setLevelData","onEnable","init","_handleSubscription","onDisable","_loadLevel","createGameObject","position","info","callback","CREATE_GAME_OBJECT","go","gon","Node","GameObject","world","node","setPosition","parent","getParent","order","key","initConfig","undefined","revive","Function","specify","activated","id","length","push","deleteGameObject","index","indexOf","splice","activate","func","SET_LEVEL_DATA","onSetLevelData","REFRESH_LEVEL","onRefreshLevel","level","objectIndex","gameObjectData","GameObjectType","name","v2","x","y","_clearLevel","forEach","levelData","json","scheduleOnce"],"mappings":";;;;;;AAAA;;AAEA;;AACA;;AAEA;;AACA;;;;AAEA;AACA;AAEAA,EAAE,CAACC,KAAH,CAAS;EACL,WAASD,EAAE,CAACE,SADP;EAGLC,UAAU,EAAE;IACR;IACAC,IAAI,EAAE;MACF,WAAS,IADP;MAEFC,IAAI,EAAEL,EAAE,CAACM,SAFP;MAGFC,OAAO,EAAE;IAHP,CAFE;IAOR;IAEA;IACAC,MAAM,EAAE;MACJ,WAAS,KADL;MAEJC,YAAY,EAAE,KAFV;MAGJC,OAAO,EAAE,KAHL;MAIJC,MAJI,oBAIK;QACL,IAAI,KAAKH,MAAT,EAAiB;UACbR,EAAE,CAACY,WAAH,CAAeC,IAAf,CAAoBC,qBAAA,CAAUC,YAA9B;QACH;MACJ;IARG,CAVA;IAoBR;IAEA;IACAC,YAAY,EAAE;MAAE,WAAS,KAAX;MAAkBP,YAAY,EAAE;IAAhC,CAvBN;IAwBRQ,KAAK,EAAE;MAAE,WAAS,IAAX;MAAiBR,YAAY,EAAE;IAA/B,CAxBC;IAyBRS,OAAO,EAAE;MAAE,WAAS,IAAX;MAAiBb,IAAI,EAAEc,sBAAvB;MAAmCV,YAAY,EAAE;IAAjD,CAzBD;IA0BRW,YAAY,EAAE;MAAE,WAAS,EAAX;MAAeX,YAAY,EAAE;IAA7B,CA1BN,CA2BR;;EA3BQ,CAHP;EAiCL;EACAY,MAlCK,oBAkCI;IACL,KAAKH,OAAL,GAAe,KAAKI,YAAL,CAAkBH,sBAAlB,KAAiC,KAAKI,YAAL,CAAkBJ,sBAAlB,CAAhD;;IAEA,KAAKK,aAAL,CAAmB,KAAKpB,IAAxB;EACH,CAtCI;EAwCLqB,QAxCK,sBAwCM;IACP,IAAI,CAAC,KAAKT,YAAV,EAAwB;MACpB,KAAKU,IAAL;IACH;;IAED,KAAKC,mBAAL,CAAyB,IAAzB;EACH,CA9CI;EAgDLC,SAhDK,uBAgDO;IACR,KAAKD,mBAAL,CAAyB,KAAzB;EACH,CAlDI;EAmDL;EAEA;EACAD,IAtDK,kBAsDE;IACH,KAAKG,UAAL;;IAEA,KAAKrB,MAAL,GAAc,IAAd;IACA,KAAKQ,YAAL,GAAoB,IAApB;EACH,CA3DI;EA6DLc,gBA7DK,4BA6DYzB,IA7DZ,EA6DkB0B,QA7DlB,EA6D4BC,IA7D5B,EA6DkCC,QA7DlC,EA6D4C;IAAA;;IAC7CjC,EAAE,CAACY,WAAH,CAAeC,IAAf,CACIC,qBAAA,CAAUoB,kBADd,EAEI7B,IAFJ,EAGI,UAAC8B,EAAD,EAAKC,GAAL,EAAa;MACT,IAAIA,GAAG,YAAYpC,EAAE,CAACqC,IAAlB,IAA0BF,EAAE,YAAYG,sBAA5C,EAAwD;QACpDH,EAAE,CAACI,KAAH,GAAW,KAAX;QACAJ,EAAE,CAACK,IAAH,CAAQC,WAAR,CAAoBV,QAApB;QACAK,GAAG,CAACM,MAAJ,GAAa,KAAI,CAACxB,OAAL,CAAayB,SAAb,CAAuBR,EAAE,CAACS,KAA1B,CAAb;;QAEA,KAAK,IAAIC,GAAT,IAAgBb,IAAI,CAACc,UAArB,EAAiC;UAC7B,IAAIV,GAAG,CAACS,GAAD,CAAH,KAAaE,SAAjB,EAA4B;YACxBX,GAAG,CAACS,GAAD,CAAH,GAAWb,IAAI,CAACc,UAAL,CAAgBD,GAAhB,CAAX;UACH;QACJ;MACJ;IACJ,CAfL,EAgBI,UAACV,EAAD,EAAKC,GAAL,EAAa;MACT,IAAIA,GAAG,YAAYpC,EAAE,CAACqC,IAAlB,IAA0BF,EAAE,YAAYG,sBAA5C,EAAwD;QACpDH,EAAE,CAACa,MAAH,YAAqBC,QAArB,IAAiCd,EAAE,CAACa,MAAH,EAAjC;QACAb,EAAE,CAACe,OAAH,YAAsBD,QAAtB,IAAkCd,EAAE,CAACe,OAAH,CAAWlB,IAAX,CAAlC;QACAC,QAAQ,YAAYgB,QAApB,IAAgChB,QAAQ,CAACE,EAAD,EAAKC,GAAL,CAAxC;QAEAD,EAAE,CAACgB,SAAH,GAAe,IAAf;QAEAhB,EAAE,CAACiB,EAAH,GAAQ,KAAI,CAAChC,YAAL,CAAkBiC,MAA1B;;QACA,KAAI,CAACjC,YAAL,CAAkBkC,IAAlB,CAAuBnB,EAAvB;MACH;IACJ,CA3BL;EA6BH,CA3FI;EA6FLoB,gBA7FK,4BA6FYpB,EA7FZ,EA6FgB;IACjB,IAAMqB,KAAK,GAAG,KAAKpC,YAAL,CAAkBqC,OAAlB,CAA0BtB,EAA1B,CAAd;;IAEA,KAAKf,YAAL,CAAkBsC,MAAlB,CAAyBF,KAAzB,EAAgC,CAAhC;EACH,CAjGI;EAkGL;EAEA;EACA7B,mBArGK,+BAqGegC,QArGf,EAqGyB;IAC1B,IAAMC,IAAI,GAAGD,QAAQ,GAAG,IAAH,GAAU,KAA/B;IAEA3D,EAAE,CAACY,WAAH,CAAegD,IAAf,EAAqB9C,qBAAA,CAAU+C,cAA/B,EAA+C,KAAKC,cAApD,EAAoE,IAApE;IACA9D,EAAE,CAACY,WAAH,CAAegD,IAAf,EAAqB9C,qBAAA,CAAUiD,aAA/B,EAA8C,KAAKC,cAAnD,EAAmE,IAAnE;EACH,CA1GI;EA4GLnC,UA5GK,wBA4GQ;IACT,IAAIoC,KAAK,GAAG,KAAKhD,KAAL,IAAc,EAA1B;;IAEA,KAAK,IAAIiD,WAAT,IAAwBD,KAAxB,EAA+B;MAC3B,IAAME,cAAc,GAAGF,KAAK,CAACC,WAAD,CAA5B;MACA,IAAM7D,IAAI,GAAG+D,0BAAA,CAAeD,cAAc,CAACE,IAA9B,CAAb;MACA,IAAMtC,QAAQ,GAAG/B,EAAE,CAACsE,EAAH,CAAMH,cAAc,CAACpC,QAAf,CAAwBwC,CAA9B,EAAiCJ,cAAc,CAACpC,QAAf,CAAwByC,CAAzD,CAAjB;MACA,IAAMxC,IAAI,GAAGmC,cAAc,CAACjB,OAAf,IAA0B,EAAvC;MAEA,KAAKpB,gBAAL,CAAsBzB,IAAtB,EAA4B0B,QAA5B,EAAsCC,IAAtC;IACH;EACJ,CAvHI;EAyHLyC,WAzHK,yBAyHS;IACV,KAAKrD,YAAL,CAAkBsD,OAAlB,CAA0B,UAACvC,EAAD,EAAQ;MAC9BA,EAAE,CAACgB,SAAH,GAAe,KAAf;IACH,CAFD;EAGH,CA7HI;EA+HL3B,aA/HK,yBA+HSmD,SA/HT,EA+HoB;IACrB,IAAIA,SAAS,YAAY3E,EAAE,CAACM,SAA5B,EAAuC;MACnC,KAAKW,KAAL,GAAa0D,SAAS,CAACC,IAAvB;IACH;EACJ,CAnII;EAoIL;EAEA;EACAd,cAvIK,0BAuIUa,SAvIV,EAuIqB;IACtB,KAAKnD,aAAL,CAAmBmD,SAAnB;EACH,CAzII;EA2ILX,cA3IK,4BA2IY;IAAA;;IACb,KAAKS,WAAL;;IAEA,KAAKrD,YAAL,GAAoB,EAApB;IACA,KAAKyD,YAAL,CAAkB,YAAM;MACpB,MAAI,CAAChD,UAAL;;MACA,MAAI,CAACrB,MAAL,GAAc,IAAd;IACH,CAHD;EAIH,CAnJI,CAoJL;;AApJK,CAAT","sourceRoot":"/","sourcesContent":["import GameEvent from 'GameEvent';\n\nimport GameObject from 'GameObject';\nimport GameObjectType from 'GameObjectType';\n\nimport RenderListType from 'RenderListType';\nimport RenderList from 'RenderList';\n\n//#region classes-helpers\n//#endregion\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        //#region editors fields and properties\n        data: {\n            default: null,\n            type: cc.JsonAsset,\n            tooltip: 'json уровня',\n        },\n        //#endregion\n\n        //#region public fields and properties\n        isLoad: {\n            default: false,\n            serializable: false,\n            visible: false,\n            notify() {\n                if (this.isLoad) {\n                    cc.systemEvent.emit(GameEvent.WORLD_LOADED);\n                }\n            },\n        },\n        //#endregion\n\n        //#region private fields and properties\n        _isInitiated: { default: false, serializable: false },\n        _data: { default: null, serializable: false },\n        _render: { default: null, type: RenderList, serializable: false },\n        _objectArray: { default: [], serializable: false },\n        //#endregion\n    },\n\n    //#region life-cycle callbacks\n    onLoad() {\n        this._render = this.getComponent(RenderList) || this.addComponent(RenderList);\n\n        this._setLevelData(this.data);\n    },\n\n    onEnable() {\n        if (!this._isInitiated) {\n            this.init();\n        }\n\n        this._handleSubscription(true);\n    },\n\n    onDisable() {\n        this._handleSubscription(false);\n    },\n    //#endregion\n\n    //#region public methods\n    init() {\n        this._loadLevel();\n\n        this.isLoad = true;\n        this._isInitiated = true;\n    },\n\n    createGameObject(type, position, info, callback) {\n        cc.systemEvent.emit(\n            GameEvent.CREATE_GAME_OBJECT,\n            type,\n            (go, gon) => {\n                if (gon instanceof cc.Node && go instanceof GameObject) {\n                    go.world = this;\n                    go.node.setPosition(position);\n                    gon.parent = this._render.getParent(go.order);\n\n                    for (let key in info.initConfig) {\n                        if (gon[key] !== undefined) {\n                            gon[key] = info.initConfig[key];\n                        }\n                    }\n                }\n            },\n            (go, gon) => {\n                if (gon instanceof cc.Node && go instanceof GameObject) {\n                    go.revive instanceof Function && go.revive();\n                    go.specify instanceof Function && go.specify(info);\n                    callback instanceof Function && callback(go, gon);\n\n                    go.activated = true;\n\n                    go.id = this._objectArray.length;\n                    this._objectArray.push(go);\n                }\n            }\n        );\n    },\n\n    deleteGameObject(go) {\n        const index = this._objectArray.indexOf(go);\n\n        this._objectArray.splice(index, 1);\n    },\n    //#endregion\n\n    //#region private methods\n    _handleSubscription(activate) {\n        const func = activate ? 'on' : 'off';\n\n        cc.systemEvent[func](GameEvent.SET_LEVEL_DATA, this.onSetLevelData, this);\n        cc.systemEvent[func](GameEvent.REFRESH_LEVEL, this.onRefreshLevel, this);\n    },\n\n    _loadLevel() {\n        let level = this._data || [];\n\n        for (let objectIndex in level) {\n            const gameObjectData = level[objectIndex];\n            const type = GameObjectType[gameObjectData.name];\n            const position = cc.v2(gameObjectData.position.x, gameObjectData.position.y);\n            const info = gameObjectData.specify || {};\n\n            this.createGameObject(type, position, info);\n        }\n    },\n\n    _clearLevel() {\n        this._objectArray.forEach((go) => {\n            go.activated = false;\n        });\n    },\n\n    _setLevelData(levelData) {\n        if (levelData instanceof cc.JsonAsset) {\n            this._data = levelData.json;\n        }\n    },\n    //#endregion\n\n    //#region event handlers\n    onSetLevelData(levelData) {\n        this._setLevelData(levelData);\n    },\n\n    onRefreshLevel() {\n        this._clearLevel();\n\n        this._objectArray = [];\n        this.scheduleOnce(() => {\n            this._loadLevel();\n            this.isLoad = true;\n        });\n    },\n    //#endregion\n});\n"]}